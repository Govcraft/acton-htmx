//! Integration tests for {{model_name}} CRUD operations
//!
//! Generated by acton-dx scaffold

use acton_dx::prelude::*;
use axum::{
    body::Body,
    http::{Request, StatusCode},
};
use serde_json::json;
use tower::ServiceExt;

use crate::{
    models::{{model_snake}},
    state::AppState,
    app_router,
};

#[tokio::test]
async fn test_list_{{model_snake}}s() {
    let state = AppState::test().await;
    let app = app_router(state);

    let response = app
        .oneshot(
            Request::builder()
                .uri("{{route_path}}")
                .body(Body::empty())
                .unwrap(),
        )
        .await
        .unwrap();

    assert_eq!(response.status(), StatusCode::OK);
}

#[tokio::test]
async fn test_create_{{model_snake}}() {
    let state = AppState::test().await;
    let app = app_router(state.clone());

    // Create test {{model_snake}}
    let form_data = serde_urlencoded::to_string(&json!({
        {{#each fields}}
        "{{name}}": {{#if optional}}null{{else}}{{default_value}}{{/if}},
        {{/each}}
    }))
    .unwrap();

    let response = app
        .oneshot(
            Request::builder()
                .method("POST")
                .uri("{{route_path}}")
                .header("content-type", "application/x-www-form-urlencoded")
                .body(Body::from(form_data))
                .unwrap(),
        )
        .await
        .unwrap();

    // Should redirect after creation
    assert!(response.status().is_redirection() || response.status().is_success());

    // Verify {{model_snake}} was created
    let {{model_snake}}s = {{model_snake}}::Entity::find_all(&state.db).await.unwrap();
    assert!(!{{model_snake}}s.is_empty());
}

#[tokio::test]
async fn test_show_{{model_snake}}() {
    let state = AppState::test().await;

    // Create test {{model_snake}}
    let form = crate::forms::{{model_snake}}::{{model_name}}Form::new(
        {{#each fields}}
        {{#if optional}}None{{else}}{{default_value}}{{/if}},
        {{/each}}
    );
    let {{model_snake}} = {{model_snake}}::Entity::create(&state.db, form).await.unwrap();

    let app = app_router(state);

    let response = app
        .oneshot(
            Request::builder()
                .uri(&format!("{{route_path}}/{}", {{model_snake}}.id))
                .body(Body::empty())
                .unwrap(),
        )
        .await
        .unwrap();

    assert_eq!(response.status(), StatusCode::OK);
}

#[tokio::test]
async fn test_update_{{model_snake}}() {
    let state = AppState::test().await;

    // Create test {{model_snake}}
    let form = crate::forms::{{model_snake}}::{{model_name}}Form::new(
        {{#each fields}}
        {{#if optional}}None{{else}}{{default_value}}{{/if}},
        {{/each}}
    );
    let {{model_snake}} = {{model_snake}}::Entity::create(&state.db, form).await.unwrap();

    let app = app_router(state.clone());

    // Update {{model_snake}}
    let form_data = serde_urlencoded::to_string(&json!({
        {{#each fields}}
        "{{name}}": {{#if optional}}null{{else}}{{default_value}}{{/if}},
        {{/each}}
    }))
    .unwrap();

    let response = app
        .oneshot(
            Request::builder()
                .method("PUT")
                .uri(&format!("{{route_path}}/{}", {{model_snake}}.id))
                .header("content-type", "application/x-www-form-urlencoded")
                .body(Body::from(form_data))
                .unwrap(),
        )
        .await
        .unwrap();

    assert!(response.status().is_success());

    // Verify {{model_snake}} was updated
    let updated = {{model_snake}}::Entity::find_by_id(&state.db, {{model_snake}}.id)
        .await
        .unwrap()
        .expect("{{model_name}} should exist");
    assert_eq!(updated.id, {{model_snake}}.id);
}

#[tokio::test]
async fn test_delete_{{model_snake}}() {
    let state = AppState::test().await;

    // Create test {{model_snake}}
    let form = crate::forms::{{model_snake}}::{{model_name}}Form::new(
        {{#each fields}}
        {{#if optional}}None{{else}}{{default_value}}{{/if}},
        {{/each}}
    );
    let {{model_snake}} = {{model_snake}}::Entity::create(&state.db, form).await.unwrap();

    let app = app_router(state.clone());

    let response = app
        .oneshot(
            Request::builder()
                .method("DELETE")
                .uri(&format!("{{route_path}}/{}", {{model_snake}}.id))
                .body(Body::empty())
                .unwrap(),
        )
        .await
        .unwrap();

    assert!(response.status().is_success());

    // Verify {{model_snake}} was deleted
    let deleted = {{model_snake}}::Entity::find_by_id(&state.db, {{model_snake}}.id)
        .await
        .unwrap();
    assert!(deleted.is_none());
}

#[tokio::test]
async fn test_validation_errors() {
    let state = AppState::test().await;
    let app = app_router(state);

    // Attempt to create with invalid data
    let form_data = serde_urlencoded::to_string(&json!({})).unwrap();

    let response = app
        .oneshot(
            Request::builder()
                .method("POST")
                .uri("{{route_path}}")
                .header("content-type", "application/x-www-form-urlencoded")
                .body(Body::from(form_data))
                .unwrap(),
        )
        .await
        .unwrap();

    assert_eq!(response.status(), StatusCode::UNPROCESSABLE_ENTITY);
}
